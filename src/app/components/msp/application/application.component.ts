import {Component, Inject, ViewChild} from '@angular/core';
import { MspProgressBarItem } from '../common/progressBar/progressBarDataItem.model';
import {MspProgressBarComponent} from '../common/progressBar/progressBar.component';
// import ProcessService, {ProcessStep} from "../service/process.service";
import {ProcessService, ProcessStep} from '../service/process.service';

import { environment } from '../../../../environments/environment';

import { Router, NavigationEnd } from '@angular/router';
import { Subscription } from 'rxjs';
import { filter } from 'rxjs/operators';
import { MspLogService } from '../service/log.service';

/**
 * Application for MSP
 */
@Component({
  templateUrl: './application.component.html',
  styleUrls: ['./application.component.scss']
})

export class ApplicationComponent  {

  lang = require('./i18n');

  @ViewChild('progressBar') progressBar: MspProgressBarComponent;
  routerSubscription: Subscription;

  get applicationProgressBarList(): Array<MspProgressBarItem> {
    if (this.processService.process == null ||
      this.processService.process.processSteps == null) {
      this.initProcessService();
    }

    return [
      new MspProgressBarItem(this.lang('./en/index.js').progressStep1, this.processService.process.processSteps[0].route),
      new MspProgressBarItem(this.lang('./en/index.js').progressStep2, this.processService.process.processSteps[1].route),
      new MspProgressBarItem(this.lang('./en/index.js').progressStep3, this.processService.process.processSteps[2].route),
      new MspProgressBarItem(this.lang('./en/index.js').progressStep4, this.processService.process.processSteps[3].route)
    ];
  }

  constructor (private processService: ProcessService,
              private logService: MspLogService,
              private router: Router) {
    environment.appConstants.serviceName = this.lang('./en/index.js').serviceName;
    this.initProcessService();
  }

  ngOnInit() {
    /*this.logService.log({
      name: "Application - Loaded Page",
      url: this.router.url
    },"Application - Load Page")*/

    this.routerSubscription = this.router.events
      .pipe(filter(event => event instanceof NavigationEnd))
      .subscribe(event => {
          if (this.router.url.indexOf('/confirmation/') === -1) {//toned down logs.no log for confirmation page
              this.logService.log({
                  name: 'Enrolment - Loaded Page ',
                  url: this.router.url
              }, 'Enrolment - Loaded Page ');
          }
      });
  }

  ngOnDestroy() {
      if (this.routerSubscription && !this.routerSubscription.closed) {
          this.routerSubscription.unsubscribe();
      }
  }

  private initProcessService () {
    this.processService.init([
      new ProcessStep('/msp/application/prepare'),
      new ProcessStep('/msp/application/personal-info'),
      new ProcessStep('/msp/application/address'),
      new ProcessStep('/msp/application/review'),
      new ProcessStep('/msp/application/sending')]);
  }

}
